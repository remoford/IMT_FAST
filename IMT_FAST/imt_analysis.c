#include "imt_analysis.h"
#include "emgpdf.h"
#include "onestage.h"
#include "onestagepdf_lag.h"
#include "twostage.h"
#include "threestage.h"
#include "gsl/gsl_multimin.h"
#include "gsl/gsl_statistics_double.h"
#include "time.h"
#include "main.h"
#include "loglikelihood.h"

#define _VERBOSE
#define _CONV2WALD
#define _FUCCI_DATA

void IMT_analysis_April2017(const char *model)
{
    printf("Using GSL minimizer\n");

	
#ifdef _FUCCI_DATA
	// Fucci
	int data_size = 266;
	static distType data[266] =
	{ 11.9, 10.6, 11.6, 9.8, 9.3, 9.0, 11.6, 11.1,
		12.4, 13.7, 12.4, 11.9, 10.3, 12.9, 14.7, 11.6, 13.4, 13.4, 11.6, 10.3, 9.3,
		13.7, 9.6, 10.1, 9.8, 10.9, 16.0, 9.3, 9.6, 10.3, 11.4, 10.6, 8.5, 10.3,
		11.1, 8.0, 10.6, 7.5, 12.9, 9.0, 8.5, 12.4, 11.6, 9.6, 9.6, 14.7, 9.8, 10.3,
		12.1, 8.8, 10.6, 12.1, 13.4, 12.4, 8.8, 13.2, 10.1, 11.6, 11.1, 15.8, 12.1,
		12.7, 12.7, 11.1, 13.2, 11.9, 12.4, 13.2, 14.0, 8.0, 8.8, 9.3, 16.5, 14.5,
		10.1, 14.2, 7.8, 13.2, 8.8, 8.8, 10.1, 11.9, 12.9, 14.5, 10.9, 10.6, 14.0,
		8.8, 8.8, 9.0, 10.9, 14.5, 9.6, 12.4, 11.9, 12.4, 11.1, 14.5, 10.3, 12.4,
		12.7, 11.9, 10.3, 13.7, 15.5, 14.5, 11.6, 10.6, 15.5, 14.7, 8.8, 11.6, 8.3,
		17.6, 12.4, 11.6, 15.0, 13.7, 12.7, 10.9, 7.2, 8.5, 8.3, 9.6, 11.4, 12.9,
		11.6, 13.4, 10.1, 11.6, 8.8, 12.4, 10.3, 16.3, 10.9, 10.1, 8.8, 9.3, 15.2,
		8.5, 11.1, 8.3, 11.4, 11.9, 9.3, 9.8, 16.3, 12.7, 9.0, 11.9, 9.3, 10.3, 13.4,
		11.4, 12.9, 12.4, 9.6, 10.3, 13.2, 10.6, 9.8, 11.9, 14.2, 13.4, 9.3, 9.6,
		12.1, 11.9, 10.1, 14.0, 12.9, 21.7, 11.6, 12.1, 10.3, 9.8, 14.2, 13.7, 7.2,
		10.9, 10.1, 9.6, 13.4, 13.2, 16.3, 11.6, 14.0, 10.9, 14.2, 12.4, 12.4, 13.4,
		17.6, 10.1, 10.9, 14.0, 12.9, 9.0, 13.4, 15.0, 16.0, 8.0, 9.8, 12.4, 8.5,
		9.6, 12.7, 12.1, 15.0, 16.0, 10.9, 14.2, 13.7, 11.9, 16.8, 11.4, 13.4, 12.4,
		22.0, 12.4, 16.8, 12.1, 10.3, 13.4, 11.6, 10.1, 14.5, 10.6, 11.9, 15.5, 9.8,
		12.4, 10.1, 8.0, 9.0, 9.3, 13.2, 11.1, 12.7, 12.1, 10.1, 13.2, 14.5, 10.1,
		12.7, 12.9, 11.9, 12.4, 11.1, 8.5, 14.5, 16.5, 12.4, 9.0, 11.1, 9.8, 11.1,
		11.1, 8.8, 13.2, 17.6, 16.8, 10.9, 12.4, 8.5, 14.7 };
	
#else
	// Erlotinib
	int data_size = 198;
	static distType data[] = {
		20.5,16.2,16.3,16.1,17.3,15.8,16.3,20.4,49.9,14.3,14.9,15.8,17.7,15.1,13.5,
		13.7,13.8,14.4,16.9,14.5,14.8,15.6,39.2,16.2,17.3,13.9,15.5,13.5,14.9,14.3,
		15.3,15.4,20.7,17.0,17.5,13.9,14.8,15.2,13.4,14.8,12.5,13.2,16.4,16.5,13.7,
		14.8,13.0,14.0,12.4,11.9,13.4,14.4,15.5,19.8,20.4,12.6,13.6,14.6,30.6,14.3,
		18.0,13.3,19.4,12.4,13.0,13.4,12.8,13.3,14.9,15.4,15.6,18.5,13.1,14.6,16.4,
		18.6,14.3,14.9,15.2,16.9,18.2,26.2,33.5,13.3,13.3,14.3,14.3,14.8,16.6,13.3,
		14.1,14.3,12.4,11.8,11.9,13.8,15.6,23.8,25.3,25.8,25.9,15.3,23.7,12.4,12.8,
		12.8,14.2,24.1,55.4,36.3,12.2,12.8,14.8,16.5,13.3,14.1,14.6,16.4,19.9,22.2,
		26.5,36.9,12.0,12.4,13.2,16.8,12.8,14.5,16.5,18.6,19.4,22.8,16.3,16.4,15.5,
		15.9,12.4,12.9,13.4,14.6,15.2,16.1,14.7,15.9,16.6,18.9,21.8,26.5,20.2,38.5,
		13.7,14.8,15.5,15.7,12.9,13.4,13.7,23.7,14.5,16.1,36.7,39.0,20.2,38.8,37.9,
		13.6,14.6,19.3,21.0,13.0,18.9,28.7,32.7,33.5,35.0,13.5,14.4,12.5,14.6,15.5,
		37.2,12.5,13.0,18.7,13.4,13.6,16.6,16.9,12.9,13.6,21.7,30.6,13.8,14.3,16.8,
		17.1,24.3,28.2 };
#endif
	

	configStruct config;

	config.data = data;
	config.data_size = data_size;

	int emgfitnomle = 0;
    int twostagefitnomle = 0;
    int onestagelagnomle = 0;
    int onestagefitnomle = 0;
    int threestagefitnomle = 0;
   
    printf("FUCCI Data\n\n");

    const char *twostagefitnomle_str = "twostage";
    const char *onestagelagnomle_str = "onestagelag";
    const char *onestagefitnomle_str = "onestage";
    const char *emgfitnomle_str = "emg";
    const char *threestagefitnomle_str = "threestage";
    const char *all_str = "all";

	/* choose model to fit */
    if (strcmp(model, twostagefitnomle_str) == 0) {
		twostagefitnomle = 1;

    } else if (strcmp(model, onestagelagnomle_str) == 0) {
		onestagelagnomle = 1;

    } else if (strcmp(model, onestagefitnomle_str) == 0) {
		onestagefitnomle = 1;

    } else if (strcmp(model, emgfitnomle_str) == 0) {
		emgfitnomle = 1;

    } else if (strcmp(model, threestagefitnomle_str) == 0) {
		threestagefitnomle = 1;

    } else if (strcmp(model, all_str) == 0) {
		emgfitnomle = 1;
		onestagefitnomle = 1;
		onestagelagnomle = 1;
		twostagefitnomle = 1;
		threestagefitnomle = 1;

    } else {
		printf("No valid model was selected, quitting.\n");

    }

	if (emgfitnomle == 1) {
		optimize_emg(data, data_size, config);
	}

	if (onestagefitnomle == 1) {
		optimize_onestage(data, data_size, config);
	}

	if (onestagelagnomle == 1) {
		optimize_onestagelag(data, data_size, config);
	}

	if (twostagefitnomle) {
		int numseeds_twostage = 45;
		double seeds_twostage[45][4] = {
			{ 0.339700, 0.235900, 0.339700, 0.235900 } ,
		{ 0.339700, 0.235900, 0.339700, 0.118000 } ,
		{ 0.339700, 0.235900, 0.339700, 0.078600 } ,
		{ 0.339700, 0.235900, 0.169900, 0.235900 } ,
		{ 0.339700, 0.235900, 0.169900, 0.118000 } ,
		{ 0.339700, 0.235900, 0.169900, 0.078600 } ,
		{ 0.339700, 0.235900, 0.113200, 0.235900 } ,
		{ 0.339700, 0.235900, 0.113200, 0.118000 } ,
		{ 0.339700, 0.235900, 0.113200, 0.078600 } ,
		{ 0.339700, 0.118000, 0.339700, 0.118000 } ,
		{ 0.339700, 0.118000, 0.339700, 0.078600 } ,
		{ 0.339700, 0.118000, 0.169900, 0.235900 } ,
		{ 0.339700, 0.118000, 0.169900, 0.118000 } ,
		{ 0.339700, 0.118000, 0.169900, 0.078600 } ,
		{ 0.339700, 0.118000, 0.113200, 0.235900 } ,
		{ 0.339700, 0.118000, 0.113200, 0.118000 } ,
		{ 0.339700, 0.118000, 0.113200, 0.078600 } ,
		{ 0.339700, 0.078600, 0.339700, 0.078600 } ,
		{ 0.339700, 0.078600, 0.169900, 0.235900 } ,
		{ 0.339700, 0.078600, 0.169900, 0.118000 } ,
		{ 0.339700, 0.078600, 0.169900, 0.078600 } ,
		{ 0.339700, 0.078600, 0.113200, 0.235900 } ,
		{ 0.339700, 0.078600, 0.113200, 0.118000 } ,
		{ 0.339700, 0.078600, 0.113200, 0.078600 } ,
		{ 0.169900, 0.235900, 0.169900, 0.235900 } ,
		{ 0.169900, 0.235900, 0.169900, 0.118000 } ,
		{ 0.169900, 0.235900, 0.169900, 0.078600 } ,
		{ 0.169900, 0.235900, 0.113200, 0.235900 } ,
		{ 0.169900, 0.235900, 0.113200, 0.118000 } ,
		{ 0.169900, 0.235900, 0.113200, 0.078600 } ,
		{ 0.169900, 0.118000, 0.169900, 0.118000 } ,
		{ 0.169900, 0.118000, 0.169900, 0.078600 } ,
		{ 0.169900, 0.118000, 0.113200, 0.235900 } ,
		{ 0.169900, 0.118000, 0.113200, 0.118000 } ,
		{ 0.169900, 0.118000, 0.113200, 0.078600 } ,
		{ 0.169900, 0.078600, 0.169900, 0.078600 } ,
		{ 0.169900, 0.078600, 0.113200, 0.235900 } ,
		{ 0.169900, 0.078600, 0.113200, 0.118000 } ,
		{ 0.169900, 0.078600, 0.113200, 0.078600 } ,
		{ 0.113200, 0.235900, 0.113200, 0.235900 } ,
		{ 0.113200, 0.235900, 0.113200, 0.118000 } ,
		{ 0.113200, 0.235900, 0.113200, 0.078600 } ,
		{ 0.113200, 0.118000, 0.113200, 0.118000 } ,
		{ 0.113200, 0.118000, 0.113200, 0.078600 } ,
		{ 0.113200, 0.078600, 0.113200, 0.078600 }
		};

		optimize_twostage(data_size, data, numseeds_twostage, seeds_twostage, config);
	}

	if (threestagefitnomle == 1) {
		optimize_threestage(data, data_size, config);
	}
}
